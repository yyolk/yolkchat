{"ts":1351445520041,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"// Licensed under the Apache License, Version 2.0 (the \"License\"); you may not\n// use this file except in compliance with the License.  You may obtain a copy\n// of the License at\n//\n//   http://www.apache.org/licenses/LICENSE-2.0\n//\n// Unless required by applicable law or agreed to in writing, software\n// distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n// WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the\n// License for the specific language governing permissions and limitations under\n// the License.\n\n// Usage: The passed in function is called when the page is ready.\n// CouchApp passes in the app object, which takes care of linking to \n// the proper database, and provides access to the CouchApp helpers.\n// $.couch.app(function(app) {\n//    app.db.view(...)\n//    ...\n// });\n\n(function($) {\n\n  function Design(db, name, code) {\n    this.doc_id = \"_design/\"+name;\n    if (code) {\n      this.code_path = this.doc_id + \"/\" + code;\n    } else {\n      this.code_path = this.doc_id;\n    }\n    this.view = function(view, opts) {\n      db.view(name+'/'+view, opts);\n    };\n    this.list = function(list, view, opts) {\n      db.list(name+'/'+list, view, opts);\n    };\n  }\n\n  function docForm() { alert(\"docForm has been moved to vendor/couchapp/lib/docForm.js, use app.require to load\") };\n\n  function resolveModule(path, names, parents, current) {\n    parents = parents || [];\n    if (names.length === 0) {\n      if (typeof current != \"string\") {\n        throw [\"error\",\"invalid_require_path\",\n          'Must require a JavaScript string, not: '+(typeof current)];\n      }\n      return [current, parents];\n    }\n    var n = names.shift();\n    if (n == '..') {\n      parents.pop();\n      var pp = parents.pop();\n      if (!pp) {\n        throw [\"error\", \"invalid_require_path\", path];\n      }\n      return resolveModule(path, names, parents, pp);\n    } else if (n == '.') {\n      var p = parents.pop();\n      if (!p) {\n        throw [\"error\", \"invalid_require_path\", path];\n      }\n      return resolveModule(path, names, parents, p);\n    } else {\n      parents = [];\n    }\n    if (!current[n]) {\n      throw [\"error\", \"invalid_require_path\", path];\n    }\n    parents.push(current);\n    return resolveModule(path, names, parents, current[n]);\n  }\n\n  function makeRequire(ddoc) {\n    var moduleCache = [];\n    function getCachedModule(name, parents) {\n      var key, i, len = moduleCache.length;\n      for (i=0;i<len;++i) {\n        key = moduleCache[i].key;\n        if (key[0] === name && key[1] === parents) {\n          return moduleCache[i].module;\n        }\n      }\n      return null;\n    }\n    function setCachedModule(name, parents, module) {\n      moduleCache.push({ key: [name, parents], module: module });\n    }\n    var require = function (name, parents) {\n      var cachedModule = getCachedModule(name, parents);\n      if (cachedModule !== null) {\n        return cachedModule;\n      }\n      var exports = {};\n      var resolved = resolveModule(name, name.split('/'), parents, ddoc);\n      var source = resolved[0]; \n      parents = resolved[1];\n      var s = \"var func = function (exports, require) { \" + source + \" };\";\n      try {\n        eval(s);\n        func.apply(ddoc, [exports, function(name) {return require(name, parents)}]);\n      } catch(e) { \n        throw [\"error\",\"compilation_error\",\"Module require('\"+name+\"') raised error \"+e.toSource()]; \n      }\n      setCachedModule(name, parents, exports);\n      return exports;\n    }\n    return require;\n  };\n\n  function mockReq() {\n    var p = document.location.pathname.split('/'),\n      qs = document.location.search.replace(/^\\?/,'').split('&'),\n      q = {};\n    qs.forEach(function(param) {\n      var ps = param.split('='),\n        k = decodeURIComponent(ps[0]),\n        v = decodeURIComponent(ps[1]);\n      if ([\"startkey\", \"endkey\", \"key\"].indexOf(k) != -1) {\n        q[k] = JSON.parse(v);\n      } else {\n        q[k] = v;\n      }\n    });\n    p.shift();\n    return {\n      path : p,\n      query : q\n    };\n  };\n\n  $.couch.app = $.couch.app || function(appFun, opts) {\n    opts = opts || {};\n    var urlPrefix = (opts.urlPrefix || \"\"),\n      index = urlPrefix.split('/').length,\n      fragments = unescape(document.location.href).split('/'),\n      dbname = opts.db || fragments[index + 2],\n      dname = opts.design || fragments[index + 4];\n    $.couch.urlPrefix = urlPrefix;\n    var db = $.couch.db(dbname),\n      design = new Design(db, dname, opts.load_path);\n    var appExports = $.extend({\n      db : db,\n      design : design,\n      view : design.view,\n      list : design.list,\n      docForm : docForm, // deprecated\n      req : mockReq()\n    }, $.couch.app.app);\n    function handleDDoc(ddoc) {        \n      if (ddoc) {\n        appExports.ddoc = ddoc;\n        appExports.require = makeRequire(ddoc);\n      }\n      appFun.apply(appExports, [appExports]);\n    }\n    if (opts.ddoc) {\n      // allow the ddoc to be embedded in the html\n      // to avoid a second http request\n      $.couch.app.ddocs[design.doc_id] = opts.ddoc;\n    }\n    if ($.couch.app.ddocs[design.doc_id]) {\n      $(function() {handleDDoc($.couch.app.ddocs[design.doc_id])});\n    } else {\n      // only open 1 connection for this ddoc \n      if ($.couch.app.ddoc_handlers[design.doc_id]) {\n        // we are already fetching, just wait\n        $.couch.app.ddoc_handlers[design.doc_id].push(handleDDoc);\n      } else {\n        $.couch.app.ddoc_handlers[design.doc_id] = [handleDDoc];\n        // use getDbProperty to bypass %2F encoding on _show/app\n        db.getDbProperty(design.code_path, {\n          success : function(doc) {\n            $.couch.app.ddocs[design.doc_id] = doc;\n            $.couch.app.ddoc_handlers[design.doc_id].forEach(function(h) {\n              $(function() {h(doc)});\n            });\n            $.couch.app.ddoc_handlers[design.doc_id] = null;\n          },\n          error : function() {\n            $.couch.app.ddoc_handlers[design.doc_id].forEach(function(h) {\n              $(function() {h()});\n            });\n            $.couch.app.ddoc_handlers[design.doc_id] = null;\n          }\n        });\n      }\n    }\n  };\n  $.couch.app.ddocs = {};\n  $.couch.app.ddoc_handlers = {};\n  // legacy support. $.CouchApp is deprecated, please use $.couch.app\n  $.CouchApp = $.couch.app;\n})(jQuery);\n\n// JavaScript 1.6 compatibility functions that are missing from IE7/IE8\n\nif (!Array.prototype.forEach)\n{\n    Array.prototype.forEach = function(fun /*, thisp*/)\n    {\n        var len = this.length >>> 0;\n        if (typeof fun != \"function\")\n            throw new TypeError();\n\n        var thisp = arguments[1];\n        for (var i = 0; i < len; i++)\n        {\n            if (i in this)\n                fun.call(thisp, this[i], i, this);\n        }\n    };\n}\n\nif (!Array.prototype.indexOf)\n{\n    Array.prototype.indexOf = function(elt)\n    {\n        var len = this.length >>> 0;\n\n        var from = Number(arguments[1]) || 0;\n        from = (from < 0)\n                ? Math.ceil(from)\n                : Math.floor(from);\n        if (from < 0)\n            from += len;\n\n        for (; from < len; from++)\n        {\n            if (from in this &&\n                this[from] === elt)\n                return from;\n        }\n        return -1;\n    };\n}\n"]],"start1":0,"start2":0,"length1":0,"length2":7258}]],"length":7258}
